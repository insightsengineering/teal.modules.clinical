<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quick start: `substitute` for NSE • teal.modules.clinical</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Quick start: `substitute` for NSE">
<meta property="og:description" content="teal.modules.clinical">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">teal.modules.clinical</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.8.8</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/quickstart_substitute.html">Quick start: `substitute` for NSE</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
<!-- start_releases -->
<li class="dropdown">
	<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
Other releases
<span class="caret"></span></a><ul class="dropdown-menu" role="menu">
   <li><a href="../../index.html">latest</a></li>
   <li><a href="../../6-multisite-pkgdown@main/index.html">6-multisite-pkgdown@main</a></li>
   <li><a href="../../pre-release/index.html">pre-release</a></li>
   <li><a href="../../v0.8.10/index.html">v0.8.10</a></li>
   <li><a href="../../v0.8.9/index.html">v0.8.9</a></li>
   <li><a href="../../v0.8.8/index.html">v0.8.8</a></li>
   <li><a href="../../v0.8.7/index.html">v0.8.7</a></li>
   <li><a href="../../v0.8.6/index.html">v0.8.6</a></li>
   <li><a href="../../v0.8.5/index.html">v0.8.5</a></li>
   <li><a href="../../v0.8.4/index.html">v0.8.4</a></li>
   <li><a href="../../v0.8.3/index.html">v0.8.3</a></li>
   <li><a href="../../v0.8.2/index.html">v0.8.2</a></li>
   <li><a href="../../v0.8.1/index.html">v0.8.1</a></li>
   <li><a href="../../v0.8.0/index.html">v0.8.0</a></li>
   <li><a href="../../v0.7.0/index.html">v0.7.0</a></li>
   <li><a href="../../v0.6.0/index.html">v0.6.0</a></li>
</ul></li>
<!-- end_releases -->
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.roche.com/NEST/teal.modules.clinical">
    <span class="fas fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Quick start: <code>substitute</code> for NSE</h1>
                        <h4 class="author">Francois Collin</h4>
            
            <h4 class="date">2021-05-05</h4>
      
      
      <div class="hidden name"><code>quickstart_substitute.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<div id="section" class="section level2">
<h2></h2>
<p>Considering an expression, R usually evaluates it and returns its value. Instead of focusing on the value, it is also possible to work with the <strong>code</strong> which generated the <strong>value</strong>. This is where non standard evaluation, or NSE, starts. The function <code>substitute</code> is an important element of non-standard evaluation. For instance, if we consider <code>a</code> defined such as <code>a &lt;- 5</code>, then the expression <code>a</code> returns 5, the <code><a href="https://rdrr.io/r/base/substitute.html">substitute(a)</a></code> returns the code to obtain the value: <code>a</code>.</p>
<p>The principle on which relies <code>teal</code> is to:</p>
<ol style="list-style-type: lower-roman">
<li>generate expressions.</li>
<li>return the result of the expression in the result panel of the app.</li>
<li>return the corresponding code (or expression) with <code>Show R Code</code>.</li>
</ol>
<p>The expression returning the displayed value must be reactive. The information in the encoding in one hand and the filtering panel on the other hand modify the expression and the displayed value. As so, teal needs to work both on expressions and values and relies heavily on NSE.</p>
<p>The NSE is an advanced notion and mixing it with Shiny app development is a source of difficulties:</p>
<ul>
<li>hindered efficient coding as the Shiny app must be run to check the good execution of the code.</li>
<li>limited possibilities for testing.</li>
</ul>
<p>As an alternative, it is possible to focus first on the NSE aspects in plain R, and secondly, only once ready, integrate it in the Shiny App. Hereafter, are few practical examples demonstrating how NSE works. The choice was made to focus on <code>substitute</code>.</p>
</div>
</div>
<div id="basic" class="section level1">
<h1 class="hasAnchor">
<a href="#basic" class="anchor"></a>Basic</h1>
<div id="principle" class="section level2">
<h2 class="hasAnchor">
<a href="#principle" class="anchor"></a>Principle</h2>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="no">non_evaluated_expression</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(<span class="kw">expr</span> <span class="kw">=</span> <span class="no">a</span> + <span class="no">b</span>)
<span class="no">non_evaluated_expression</span>
<span class="co">## a + b</span>
<span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="no">non_evaluated_expression</span>)
<span class="co">## Error in eval(non_evaluated_expression): object 'b' not found</span></pre></body></html></div>
<p>What happened?</p>
<ul>
<li>
<code>substitute</code> returns the code and not the value,</li>
<li>it even does not try the code, therefore it is possible to return an expression which does not make sense (yet), for instance involving two non defined objects.</li>
<li>If the values of <code>a</code> and <code>b</code> exist, the expression can run without error (below).</li>
</ul>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">a</span> <span class="kw">&lt;-</span> <span class="fl">1</span>
<span class="no">b</span> <span class="kw">&lt;-</span> <span class="fl">5</span>
<span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="no">non_evaluated_expression</span>)
<span class="co">## [1] 6</span></pre></body></html></div>
<p>Now, the function name <code>substitute</code> is for a reason. Not only returning the expression, it also <strong>operates substitutions</strong> of some terms within a given expression.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">fun</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">a</span>, <span class="no">b</span>) {
  <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(<span class="kw">expr</span> <span class="kw">=</span> <span class="no">a</span> + <span class="no">b</span>)
}
<span class="no">non_evaluated_expression</span> <span class="kw">&lt;-</span> <span class="fu">fun</span>(<span class="fl">5</span>, -<span class="fl">2</span>)
<span class="no">non_evaluated_expression</span>
<span class="co">## 5 + -2</span>
<span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="no">non_evaluated_expression</span>)
<span class="co">## [1] 3</span></pre></body></html></div>
<p>What happened?</p>
<ul>
<li>the objects <code>a</code> and <code>b</code> exist in the function environment where <code>substitute</code> is called.</li>
<li>the terms of the expression within <code>substitute</code> were replaced by the values of <code>a</code> and <code>b</code>.</li>
</ul>
<p>Indeed, before returning the expression, <code>substitute</code> verifies if <code>a</code> and <code>b</code> don’t have any value existing in the evaluation environment. If so, values of <code>a</code> and <code>b</code> are used in the expression.</p>
<p>It is also possible to use the second argument of <code>substitute</code>, <code>env</code>, an environment (or a list) containing objects. If the expression submitted in <code>substitute</code> has corresponding objects in <code>env</code>, the terms within the expression will be substituted with provided values:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">non_evaluated_expression</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(
  <span class="kw">expr</span> <span class="kw">=</span> <span class="no">a</span> + <span class="no">b</span>,
  <span class="kw">env</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">a</span> <span class="kw">=</span> <span class="fl">5</span>, <span class="kw">b</span> <span class="kw">=</span> <span class="fl">5</span>)
)
<span class="no">non_evaluated_expression</span>
<span class="co">## 5 + 5</span>
<span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="no">non_evaluated_expression</span>)
<span class="co">## [1] 10</span></pre></body></html></div>
<p>What happened?</p>
<ul>
<li>The environment in which the values of <code>a</code> and <code>b</code> were taken from was directly declared within the <code>substitute</code> expression (argument <code>expr</code>) and the values were substituted (argument <code>env</code>).</li>
<li>
<code>substitute</code> returned a non-evaluated expression, use <code><a href="https://rdrr.io/r/base/eval.html">eval()</a></code> to evaluate it.</li>
</ul>
<p>With a slightly more elaborated expression:</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">non_evaluated_expression</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(
  <span class="kw">expr</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="no">x</span>), <span class="kw">main</span> <span class="kw">=</span> <span class="no">text</span>),
  <span class="kw">env</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fl">0</span>:<span class="fl">10</span>, <span class="kw">text</span> <span class="kw">=</span> <span class="st">"A graph"</span>)
)
<span class="no">non_evaluated_expression</span>
<span class="co">## plot(x = 0:10, y = exp(0:10), main = "A graph")</span>
<span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="no">non_evaluated_expression</span>)</pre></body></html></div>
<p><img src="quickstart_substitute_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>Note that:</p>
<ul>
<li>
<code>x</code> as an argument name in plot has been preserved, while <code>x</code> as an object has been replaced.</li>
</ul>
</div>
<div id="replace-an-object-name" class="section level2">
<h2 class="hasAnchor">
<a href="#replace-an-object-name" class="anchor"></a>Replace an object name</h2>
<p>In formulas, character strings are not accepted, how to operate the substitution?</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="co"># Error expected:</span>
<span class="no">plot_expr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(
  <span class="kw">expr</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">y</span> ~ <span class="no">x</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">iris</span>, <span class="kw">main</span> <span class="kw">=</span> <span class="no">text</span>),
  <span class="kw">env</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="kw">x</span> <span class="kw">=</span> <span class="no">Sepal.Length</span>,
    <span class="kw">y</span> <span class="kw">=</span> <span class="no">Sepal.Width</span>,
    <span class="kw">text</span> <span class="kw">=</span> <span class="st">"Iris, again ..."</span>
  )
)
<span class="co">## Error in eval(expr, envir, enclos): object 'Sepal.Length' not found</span></pre></body></html></div>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co"># Error expected:</span>
<span class="no">plot_expr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(
  <span class="kw">expr</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">y</span> ~ <span class="no">x</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">iris</span>, <span class="kw">main</span> <span class="kw">=</span> <span class="no">text</span>),
  <span class="kw">env</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="kw">x</span> <span class="kw">=</span> <span class="st">"Sepal.Length"</span>,
    <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Sepal.Width"</span>,
    <span class="kw">text</span> <span class="kw">=</span> <span class="st">"Iris, again ..."</span>
  )
)
<span class="no">plot_expr</span>
<span class="co">## plot("Sepal.Width" ~ "Sepal.Length", data = iris, main = "Iris, again ...")</span>
<span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="no">plot_expr</span>)
<span class="co">## Error in terms.formula(formula, data = data): invalid term in model formula</span></pre></body></html></div>
<p>The object names have a special <code>name</code> <em>class</em>; <code>as.names</code> coerces a character string to an object name (alternatively, <code>as.symbol</code> provides identical result):</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">plot_expr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(
  <span class="kw">expr</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">y</span> ~ <span class="no">x</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">iris</span>, <span class="kw">main</span> <span class="kw">=</span> <span class="no">text</span>),
  <span class="kw">env</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/name.html">as.name</a></span>(<span class="st">"Sepal.Length"</span>),
    <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/name.html">as.symbol</a></span>(<span class="st">"Sepal.Width"</span>),
    <span class="kw">text</span> <span class="kw">=</span> <span class="st">"Iris, again ..."</span>
  )
)
<span class="no">plot_expr</span>
<span class="co">## plot(Sepal.Width ~ Sepal.Length, data = iris, main = "Iris, again ...")</span>
<span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="no">plot_expr</span>)</pre></body></html></div>
<p><img src="quickstart_substitute_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
</div>
<div id="what-with-dataframe-name" class="section level2">
<h2 class="hasAnchor">
<a href="#what-with-dataframe-name" class="anchor"></a>What with dataframe name?</h2>
<p>Lets imagine a pipe-flavored expression, with <code>df</code> being the term corresponding to the dataframe which should be substituted: <code>df %&gt;% plot(y ~ x, data = ., main = text)</code>.</p>
<p>The principle exposed above can work directly without addition. However, <code>df</code> in the expression is then replaced directly by the value of the object provided and not the expression generating the dataframe: the pipeline is working but not humanly readable.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">magrittr</span>)
<span class="no">short_iris</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">iris</span>)
<span class="no">plot_expr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(
  <span class="kw">expr</span> <span class="kw">=</span> <span class="no">df</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">y</span> ~ <span class="no">x</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">.</span>, <span class="kw">main</span> <span class="kw">=</span> <span class="no">text</span>),
  <span class="kw">env</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="kw">df</span> <span class="kw">=</span> <span class="no">short_iris</span>,
    <span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/name.html">as.name</a></span>(<span class="st">"Sepal.Length"</span>),
    <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/name.html">as.symbol</a></span>(<span class="st">"Sepal.Width"</span>),
    <span class="kw">text</span> <span class="kw">=</span> <span class="st">"Iris, again ..."</span>
  )
)
<span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="no">plot_expr</span>)</pre></body></html></div>
<p><img src="quickstart_substitute_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">plot_expr</span>
<span class="co">## list(Sepal.Length = c(5.1, 4.9, 4.7, 4.6, 5, 5.4), Sepal.Width = c(3.5, </span>
<span class="co">## 3, 3.2, 3.1, 3.6, 3.9), Petal.Length = c(1.4, 1.4, 1.3, 1.5, </span>
<span class="co">## 1.4, 1.7), Petal.Width = c(0.2, 0.2, 0.2, 0.2, 0.2, 0.4), Species = c(1L, </span>
<span class="co">## 1L, 1L, 1L, 1L, 1L)) %&gt;% plot(Sepal.Width ~ Sepal.Length, data = ., </span>
<span class="co">##     main = "Iris, again ...")</span></pre></body></html></div>
<p>How can we replace the value by the expression generating this value?</p>
<p>That is pretty much the topic of the vignette: <code>substitute</code>.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">plot_expr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(
  <span class="kw">expr</span> <span class="kw">=</span> <span class="no">df</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">y</span> ~ <span class="no">x</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">.</span>, <span class="kw">main</span> <span class="kw">=</span> <span class="no">text</span>),
  <span class="kw">env</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="kw">df</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(<span class="no">iris</span>),
    <span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/name.html">as.name</a></span>(<span class="st">"Sepal.Length"</span>),
    <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/name.html">as.symbol</a></span>(<span class="st">"Sepal.Width"</span>),
    <span class="kw">text</span> <span class="kw">=</span> <span class="st">"Iris, again ..."</span>
  )
)
<span class="no">plot_expr</span>
<span class="co">## iris %&gt;% plot(Sepal.Width ~ Sepal.Length, data = ., main = "Iris, again ...")</span>
<span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="no">plot_expr</span>)</pre></body></html></div>
<p><img src="quickstart_substitute_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
</div>
<div id="in-a-nutshell" class="section level2">
<h2 class="hasAnchor">
<a href="#in-a-nutshell" class="anchor"></a>In a nutshell</h2>
<ul>
<li>
<code>substitute</code> is relevant when the expression needs to be modified. It takes 2 arguments:
<ul>
<li>
<code>expr</code> the expression to be (eventually) substituted.</li>
<li>
<code>env</code> the environment in which potential replacement value might be needed.</li>
</ul>
</li>
<li>If the replacement value should be slightly more special like:
<ul>
<li>an <strong>object name</strong> (like in formulas e.g. <code>y ~ x</code>) then, use <code>as.name</code> or <code>as.symbol</code>.</li>
<li>a <strong>data frame</strong> name (like <code>iris</code>) then, use <code>substitute</code>.</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="rtables" class="section level1">
<h1 class="hasAnchor">
<a href="#rtables" class="anchor"></a><code>rtables</code>
</h1>
<div id="direct-use-of-substitute" class="section level2">
<h2 class="hasAnchor">
<a href="#direct-use-of-substitute" class="anchor"></a>Direct use of <code>substitute</code>
</h2>
<p>The <code>substitute</code> approach can be used with the new <code>rtables</code> pipelines.</p>
<p>Lets prepare an example for reporting data from LB domain. The example is based on the template <code>LBT01</code>; the target is to report in columns the lab test result per study arm, as values (<code>AVAL</code>) and changes from baseline (<code>CHG</code>), per analysis visit in rows.</p>
<p>The data can be prepared as follows:</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">random.cdisc.data</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rtables</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)
<span class="co">## </span>
<span class="co">## Attaching package: 'dplyr'</span>
<span class="co">## The following objects are masked from 'package:stats':</span>
<span class="co">## </span>
<span class="co">##     filter, lag</span>
<span class="co">## The following objects are masked from 'package:base':</span>
<span class="co">## </span>
<span class="co">##     intersect, setdiff, setequal, union</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tern</span>)
<span class="co">## Loading required package: optimx</span>
<span class="co">## Registered S3 methods overwritten by 'lme4':</span>
<span class="co">##   method                          from</span>
<span class="co">##   cooks.distance.influence.merMod car </span>
<span class="co">##   influence.merMod                car </span>
<span class="co">##   dfbeta.influence.merMod         car </span>
<span class="co">##   dfbetas.influence.merMod        car</span>
<span class="co">## Registered S3 method overwritten by 'tern':</span>
<span class="co">##   method   from </span>
<span class="co">##   tidy.glm broom</span>
<span class="no">adlb</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/random.cdisc.data/man/radlb.html">radlb</a></span>(<span class="kw">cached</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">adlb_f</span> <span class="kw">&lt;-</span> <span class="no">adlb</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(
    <span class="no">PARAM</span> <span class="kw">==</span> <span class="st">"Alanine Aminotransferase Measurement"</span> <span class="kw">&amp;</span>
      <span class="no">ARMCD</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"ARM A"</span>, <span class="st">"ARM B"</span>) <span class="kw">&amp;</span> <span class="no">AVISIT</span> <span class="kw">==</span> <span class="st">"WEEK 1 DAY 8"</span>
  )</pre></body></html></div>
<p>And the <code>rtables</code> expression is obtained as:</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">rtables_expr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(

  <span class="kw">expr</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rtables/man/basic_table.html">basic_table</a></span>() <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/rtables/man/split_cols_by.html">split_cols_by</a></span>(<span class="no">arm</span>, <span class="kw">split_fun</span> <span class="kw">=</span> <span class="no">drop_split_levels</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/rtables/man/split_rows_by.html">split_rows_by</a></span>(<span class="no">visit</span>, <span class="kw">split_fun</span> <span class="kw">=</span> <span class="no">drop_split_levels</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/rtables/man/split_cols_by_multivar.html">split_cols_by_multivar</a></span>(
      <span class="kw">vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"AVAL"</span>, <span class="st">"CHG"</span>),
      <span class="kw">varlabels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Value"</span>, <span class="st">"Change"</span>)
    ) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/tern/man/summarize_colvars.html">summarize_colvars</a></span>() <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/rtables/man/build_table.html">build_table</a></span>(<span class="kw">df</span> <span class="kw">=</span> <span class="no">df</span>),

  <span class="kw">env</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="kw">df</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(<span class="no">adlb_f</span>),
    <span class="kw">arm</span> <span class="kw">=</span> <span class="st">"ARM"</span>,
    <span class="kw">visit</span> <span class="kw">=</span> <span class="st">"AVISIT"</span>
    )
)</pre></body></html></div>
<p>The expression is valid … :</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="no">rtables_expr</span>)
<span class="co">##                       A: Drug X                   B: Placebo        </span>
<span class="co">##                   Value        Change        Value         Change   </span>
<span class="co">## --------------------------------------------------------------------</span>
<span class="co">## WEEK 1 DAY 8                                                        </span>
<span class="co">##   n                134          134           134           134     </span>
<span class="co">##   Mean (SD)     48.6 (8)     -1 (11.7)    50.4 (7.9)     0.1 (12.1) </span>
<span class="co">##   Median          48.4           -1          50.2           -1.4    </span>
<span class="co">##   Min - Max    27.7 - 64.6   -25 - 39.4   21.7 - 67.5   -24.6 - 34.8</span></pre></body></html></div>
<p>… but not easily readable …:</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">rtables_expr</span>
<span class="co">## basic_table() %&gt;% split_cols_by("ARM", split_fun = drop_split_levels) %&gt;% </span>
<span class="co">##     split_rows_by("AVISIT", split_fun = drop_split_levels) %&gt;% </span>
<span class="co">##     split_cols_by_multivar(vars = c("AVAL", "CHG"), varlabels = c("Value", </span>
<span class="co">##         "Change")) %&gt;% summarize_colvars() %&gt;% build_table(df = adlb_f)</span></pre></body></html></div>
<p>… but that can be arranged:</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">teal.devel</span>)
<span class="co">#' Stylish code</span>
<span class="co">#'</span>
<span class="co">#' Deparse an expression and display the code following NEST conventions.</span>
<span class="co">#'</span>
<span class="co">#' @param expr (`call`)\cr or possibly understood as so.</span>
<span class="co">#'</span>
<span class="no">styled_expr</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">expr</span>) {
  <span class="kw pkg">styler</span><span class="kw ns">:::</span><span class="fu"><a href="https://rdrr.io/pkg/styler/man/print.vertical.html">print.vertical</a></span>(
    <span class="kw pkg">styler</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/styler/man/style_text.html">style_text</a></span>(<span class="kw">text</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/deparse.html">deparse</a></span>(<span class="no">expr</span>), <span class="kw">style</span> <span class="kw">=</span> <span class="kw pkg">teal.devel</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/teal.devel/man/nest_style.html">nest_style</a></span>),
    <span class="kw">colored</span> <span class="kw">=</span> <span class="fl">FALSE</span>
  )
}
<span class="co">#'</span>
<span class="co">#' @examples</span>
<span class="co">#'</span>
<span class="fu"><a href="../reference/styled_expr.html">styled_expr</a></span>(<span class="no">rtables_expr</span>)
<span class="co">## basic_table() %&gt;%</span>
<span class="co">##   split_cols_by("ARM", split_fun = drop_split_levels) %&gt;%</span>
<span class="co">##   split_rows_by("AVISIT", split_fun = drop_split_levels) %&gt;%</span>
<span class="co">##   split_cols_by_multivar(</span>
<span class="co">##     vars = c("AVAL", "CHG"),</span>
<span class="co">##     varlabels = c(</span>
<span class="co">##       "Value",</span>
<span class="co">##       "Change"</span>
<span class="co">##     )</span>
<span class="co">##   ) %&gt;%</span>
<span class="co">##   summarize_colvars() %&gt;%</span>
<span class="co">##   build_table(df = adlb_f)</span></pre></body></html></div>
</div>
<div id="substitute-in-a-function" class="section level2">
<h2 class="hasAnchor">
<a href="#substitute-in-a-function" class="anchor"></a><code>substitute</code> in a function</h2>
<p>Moving further, <code>substitute</code> can actually be wrapped in a function, this way the <code>rtables</code> pipelines are <em>programmatically</em> obtained:</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="no">rtables_expr</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">df</span>,
                         <span class="no">arm</span>,
                         <span class="no">visit</span>) {
  <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(

    <span class="kw">expr</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rtables/man/basic_table.html">basic_table</a></span>() <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/rtables/man/split_cols_by.html">split_cols_by</a></span>(<span class="no">arm</span>, <span class="kw">split_fun</span> <span class="kw">=</span> <span class="no">drop_split_levels</span>) <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/rtables/man/split_rows_by.html">split_rows_by</a></span>(<span class="no">visit</span>, <span class="kw">split_fun</span> <span class="kw">=</span> <span class="no">drop_split_levels</span>) <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/rtables/man/split_cols_by_multivar.html">split_cols_by_multivar</a></span>(
        <span class="kw">vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"AVAL"</span>, <span class="st">"CHG"</span>),
        <span class="kw">varlabels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Value"</span>, <span class="st">"Change"</span>)
      ) <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/tern/man/summarize_colvars.html">summarize_colvars</a></span>() <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/rtables/man/build_table.html">build_table</a></span>(<span class="kw">df</span> <span class="kw">=</span> <span class="no">df</span>),

    <span class="kw">env</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
      <span class="kw">df</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(<span class="no">df</span>),
      <span class="kw">arm</span> <span class="kw">=</span> <span class="no">arm</span>,
      <span class="kw">visit</span> <span class="kw">=</span> <span class="no">visit</span>
    )
  )
}
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu">rtables_expr</span>(<span class="kw">df</span> <span class="kw">=</span> <span class="no">adlb_f</span>, <span class="kw">arm</span> <span class="kw">=</span> <span class="st">"ARM"</span>, <span class="kw">visit</span> <span class="kw">=</span> <span class="st">"AVISIT"</span>)
<span class="fu"><a href="../reference/styled_expr.html">styled_expr</a></span>(<span class="no">result</span>)
<span class="co">## basic_table() %&gt;%</span>
<span class="co">##   split_cols_by("ARM", split_fun = drop_split_levels) %&gt;%</span>
<span class="co">##   split_rows_by("AVISIT", split_fun = drop_split_levels) %&gt;%</span>
<span class="co">##   split_cols_by_multivar(</span>
<span class="co">##     vars = c("AVAL", "CHG"),</span>
<span class="co">##     varlabels = c(</span>
<span class="co">##       "Value",</span>
<span class="co">##       "Change"</span>
<span class="co">##     )</span>
<span class="co">##   ) %&gt;%</span>
<span class="co">##   summarize_colvars() %&gt;%</span>
<span class="co">##   build_table(df = adlb_f)</span>
<span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="no">result</span>)
<span class="co">##                       A: Drug X                   B: Placebo        </span>
<span class="co">##                   Value        Change        Value         Change   </span>
<span class="co">## --------------------------------------------------------------------</span>
<span class="co">## WEEK 1 DAY 8                                                        </span>
<span class="co">##   n                134          134           134           134     </span>
<span class="co">##   Mean (SD)     48.6 (8)     -1 (11.7)    50.4 (7.9)     0.1 (12.1) </span>
<span class="co">##   Median          48.4           -1          50.2           -1.4    </span>
<span class="co">##   Min - Max    27.7 - 64.6   -25 - 39.4   21.7 - 67.5   -24.6 - 34.8</span></pre></body></html></div>
<ul>
<li>The same results as before are obtained …</li>
<li>while, fine tuning is easier.</li>
<li>For instance, the variable designating the study arm and the visit can be changed, which is an expected feature in teal module encoding panel.</li>
</ul>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu">rtables_expr</span>(<span class="kw">df</span> <span class="kw">=</span> <span class="no">adlb_f</span>, <span class="kw">arm</span> <span class="kw">=</span> <span class="st">"ARMCD"</span>, <span class="kw">visit</span> <span class="kw">=</span> <span class="st">"AVISITN"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="no">result</span>)
<span class="co">## Split var [AVISITN] was not character or factor. Converting to factor</span>
<span class="co">##                        ARM A                       ARM B           </span>
<span class="co">##                  Value        Change        Value         Change   </span>
<span class="co">## -------------------------------------------------------------------</span>
<span class="co">## 1                                                                  </span>
<span class="co">##   n               134          134           134           134     </span>
<span class="co">##   Mean (SD)    48.6 (8)     -1 (11.7)    50.4 (7.9)     0.1 (12.1) </span>
<span class="co">##   Median         48.4           -1          50.2           -1.4    </span>
<span class="co">##   Min - Max   27.7 - 64.6   -25 - 39.4   21.7 - 67.5   -24.6 - 34.8</span>
<span class="fu"><a href="../reference/styled_expr.html">styled_expr</a></span>(<span class="no">result</span>)
<span class="co">## basic_table() %&gt;%</span>
<span class="co">##   split_cols_by("ARMCD", split_fun = drop_split_levels) %&gt;%</span>
<span class="co">##   split_rows_by("AVISITN", split_fun = drop_split_levels) %&gt;%</span>
<span class="co">##   split_cols_by_multivar(</span>
<span class="co">##     vars = c("AVAL", "CHG"),</span>
<span class="co">##     varlabels = c(</span>
<span class="co">##       "Value",</span>
<span class="co">##       "Change"</span>
<span class="co">##     )</span>
<span class="co">##   ) %&gt;%</span>
<span class="co">##   summarize_colvars() %&gt;%</span>
<span class="co">##   build_table(df = adlb_f)</span></pre></body></html></div>
</div>
<div id="chain-expressions-in-a-pipeline" class="section level2">
<h2 class="hasAnchor">
<a href="#chain-expressions-in-a-pipeline" class="anchor"></a>Chain expressions in a pipeline</h2>
<p>It is also possible to manipulate expressions, for instance, expressions might be chained in a pipeline.</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="co">#' Expressions as a pipeline</span>
<span class="co">#'</span>
<span class="co">#' Accepts expressions to be chained using the `magrittr` pipeline-flavor.</span>
<span class="co">#' </span>
<span class="co">#' @param ... (`call`)\cr or object which can be interpreted as so.</span>
<span class="co">#'    (e.g. `name`)</span>
<span class="co">#'</span>
<span class="no">pipe_expr</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">...</span>) {
  <span class="no">exprs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">...</span>))
  <span class="no">exprs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(
    <span class="no">exprs</span>,
    <span class="kw">function</span>(<span class="no">x</span>) {
      <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/deparse.html">deparse</a></span>(<span class="no">x</span>)
      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="no">x</span>, <span class="kw">collapse</span> <span class="kw">=</span> <span class="st">" "</span>)
    }
  )
  <span class="no">exprs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="no">exprs</span>)
  <span class="no">exprs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="no">exprs</span>, <span class="kw">collapse</span> <span class="kw">=</span> <span class="st">" %&gt;% "</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/parse.html">str2lang</a></span>(<span class="no">exprs</span>)
}

<span class="co">#' @examples</span>
<span class="co">#'</span>
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/pipe_expr.html">pipe_expr</a></span>(
  <span class="kw">expr1</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(<span class="no">df</span>),
  <span class="kw">expr2</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(<span class="no">head</span>)
  )
<span class="no">result</span>
<span class="co">## df %&gt;% head</span></pre></body></html></div>
<ul>
<li>Expressions can be arranged in a list, this way, it is possible to have <strong>conditional</strong> editing of expressions.</li>
<li>In the context of <code>rtables</code>, layers enclosing <code>analyze</code> call handle <code>.stats</code> option. The lean expression should include the <code>.stats</code> option, <strong>only when the default value is changed</strong>.</li>
<li>This is again an expected feature in teal module when rendering the code with <code>Show R Code</code>:</li>
</ul>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="no">rtables_expr</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">df</span>,
                         <span class="no">arm</span>,
                         <span class="no">visit</span>,
                         <span class="no">.stats</span> <span class="kw">=</span> <span class="kw">NULL</span>) {

  <span class="co"># The rtables layout is decomposed into a list of expressions.</span>
  <span class="no">lyt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()

  <span class="co"># 1. First the columns and rows:</span>
  <span class="no">lyt</span>$<span class="no">structure</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(

    <span class="kw">expr</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rtables/man/basic_table.html">basic_table</a></span>() <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/rtables/man/split_cols_by.html">split_cols_by</a></span>(<span class="no">arm</span>, <span class="kw">split_fun</span> <span class="kw">=</span> <span class="no">drop_split_levels</span>) <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/rtables/man/split_rows_by.html">split_rows_by</a></span>(<span class="no">visit</span>, <span class="kw">split_fun</span> <span class="kw">=</span> <span class="no">drop_split_levels</span>) <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/rtables/man/split_cols_by_multivar.html">split_cols_by_multivar</a></span>(
        <span class="kw">vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"AVAL"</span>, <span class="st">"CHG"</span>),
        <span class="kw">varlabels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Value"</span>, <span class="st">"Change"</span>)
      ),

    <span class="kw">env</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
      <span class="kw">arm</span> <span class="kw">=</span> <span class="no">arm</span>,
      <span class="kw">visit</span> <span class="kw">=</span> <span class="no">visit</span>
    )
  )

  <span class="co"># 2. The analyze layer which depends on the use of .stats.</span>
  <span class="no">lyt</span>$<span class="no">analyze</span> <span class="kw">&lt;-</span> <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="no">.stats</span>)) {
    <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(
      <span class="fu"><a href="https://rdrr.io/pkg/tern/man/summarize_colvars.html">summarize_colvars</a></span>()
    )
  } <span class="kw">else</span> {
    <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(
      <span class="fu"><a href="https://rdrr.io/pkg/tern/man/summarize_colvars.html">summarize_colvars</a></span>(<span class="kw">.stats</span> <span class="kw">=</span> <span class="no">.stats</span>),
      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">.stats</span> <span class="kw">=</span> <span class="no">.stats</span>)
    )
  }

  <span class="co"># 3. And finishing with rtables::build_table.</span>
  <span class="no">lyt</span>$<span class="no">build</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(
    <span class="fu"><a href="https://rdrr.io/pkg/rtables/man/build_table.html">build_table</a></span>(<span class="kw">df</span> <span class="kw">=</span> <span class="no">df</span>),
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">df</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(<span class="no">df</span>))
  )

  <span class="co"># As previously demonstrated, expressions can be manipulated and</span>
  <span class="co"># chained in a pipeline.</span>
  <span class="fu"><a href="../reference/pipe_expr.html">pipe_expr</a></span>(<span class="no">lyt</span>)
}</pre></body></html></div>
<ul>
<li>First application with standard statistics:</li>
</ul>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu">rtables_expr</span>(<span class="kw">df</span> <span class="kw">=</span> <span class="no">adlb_f</span>, <span class="kw">arm</span> <span class="kw">=</span> <span class="st">"ARM"</span>, <span class="kw">visit</span> <span class="kw">=</span> <span class="st">"AVISIT"</span>)
<span class="fu"><a href="../reference/styled_expr.html">styled_expr</a></span>(<span class="no">result</span>)
<span class="co">## basic_table() %&gt;%</span>
<span class="co">##   split_cols_by("ARM", split_fun = drop_split_levels) %&gt;%</span>
<span class="co">##   split_rows_by("AVISIT", split_fun = drop_split_levels) %&gt;%</span>
<span class="co">##   split_cols_by_multivar(</span>
<span class="co">##     vars = c("AVAL", "CHG"),</span>
<span class="co">##     varlabels = c(</span>
<span class="co">##       "Value",</span>
<span class="co">##       "Change"</span>
<span class="co">##     )</span>
<span class="co">##   ) %&gt;%</span>
<span class="co">##   summarize_colvars() %&gt;%</span>
<span class="co">##   build_table(df = adlb_f)</span>
<span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="no">result</span>)
<span class="co">##                       A: Drug X                   B: Placebo        </span>
<span class="co">##                   Value        Change        Value         Change   </span>
<span class="co">## --------------------------------------------------------------------</span>
<span class="co">## WEEK 1 DAY 8                                                        </span>
<span class="co">##   n                134          134           134           134     </span>
<span class="co">##   Mean (SD)     48.6 (8)     -1 (11.7)    50.4 (7.9)     0.1 (12.1) </span>
<span class="co">##   Median          48.4           -1          50.2           -1.4    </span>
<span class="co">##   Min - Max    27.7 - 64.6   -25 - 39.4   21.7 - 67.5   -24.6 - 34.8</span></pre></body></html></div>
<ul>
<li>Then with statistics specifications:</li>
</ul>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu">rtables_expr</span>(
  <span class="kw">df</span> <span class="kw">=</span> <span class="no">adlb_f</span>, <span class="kw">arm</span> <span class="kw">=</span> <span class="st">"ARM"</span>, <span class="kw">visit</span> <span class="kw">=</span> <span class="st">"AVISIT"</span>,
  <span class="kw">.stats</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"n"</span>, <span class="st">"mean_sd"</span>)
)
<span class="fu"><a href="../reference/styled_expr.html">styled_expr</a></span>(<span class="no">result</span>)
<span class="co">## basic_table() %&gt;%</span>
<span class="co">##   split_cols_by("ARM", split_fun = drop_split_levels) %&gt;%</span>
<span class="co">##   split_rows_by("AVISIT", split_fun = drop_split_levels) %&gt;%</span>
<span class="co">##   split_cols_by_multivar(</span>
<span class="co">##     vars = c("AVAL", "CHG"),</span>
<span class="co">##     varlabels = c(</span>
<span class="co">##       "Value",</span>
<span class="co">##       "Change"</span>
<span class="co">##     )</span>
<span class="co">##   ) %&gt;%</span>
<span class="co">##   summarize_colvars(.stats = c("n", "mean_sd")) %&gt;%</span>
<span class="co">##   build_table(df = adlb_f)</span>
<span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="no">result</span>)
<span class="co">##                     A: Drug X               B: Placebo       </span>
<span class="co">##                 Value      Change       Value        Change  </span>
<span class="co">## -------------------------------------------------------------</span>
<span class="co">## WEEK 1 DAY 8                                                 </span>
<span class="co">##   n              134         134         134          134    </span>
<span class="co">##   Mean (SD)    48.6 (8)   -1 (11.7)   50.4 (7.9)   0.1 (12.1)</span></pre></body></html></div>
</div>
<div id="including-pre-processing" class="section level2">
<h2 class="hasAnchor">
<a href="#including-pre-processing" class="anchor"></a>Including pre-processing</h2>
<p>Finally, it would also be possible to wrap several expressions into a single function.</p>
<ul>
<li>For instance, the teal module generally includes a pre-processing section:</li>
</ul>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="no">rtables_expr</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">df</span>,
                         <span class="no">paramcd</span>,
                         <span class="no">arm</span>,
                         <span class="no">visit</span>,
                         <span class="no">.stats</span> <span class="kw">=</span> <span class="kw">NULL</span>) {

  <span class="co"># y is a list which will collect two expressions:</span>
  <span class="co"># 1. y$data with the preprocessing steps.</span>
  <span class="co"># 2. y$rtables the table layout and build.</span>
  <span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()

  <span class="co"># 1. Preprocessing ---</span>
  <span class="no">y</span>$<span class="no">data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(
    <span class="no">df</span> <span class="kw">&lt;-</span> <span class="no">df</span> <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(
        <span class="no">PARAMCD</span> <span class="kw">==</span> <span class="no">paramcd</span> <span class="kw">&amp;</span>
          <span class="no">ARMCD</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"ARM A"</span>, <span class="st">"ARM B"</span>) <span class="kw">&amp;</span> <span class="no">AVISIT</span> <span class="kw">==</span> <span class="st">"WEEK 1 DAY 8"</span>
      ),
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
      <span class="kw">df</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(<span class="no">df</span>),
      <span class="kw">paramcd</span> <span class="kw">=</span> <span class="no">paramcd</span>
    )
  )

  <span class="co"># 2. rtables layout ---</span>
  <span class="no">lyt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
  <span class="no">lyt</span>$<span class="no">structure</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(

    <span class="kw">expr</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rtables/man/basic_table.html">basic_table</a></span>() <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/rtables/man/split_cols_by.html">split_cols_by</a></span>(<span class="no">arm</span>, <span class="kw">split_fun</span> <span class="kw">=</span> <span class="no">drop_split_levels</span>) <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/rtables/man/split_rows_by.html">split_rows_by</a></span>(<span class="no">visit</span>, <span class="kw">split_fun</span> <span class="kw">=</span> <span class="no">drop_split_levels</span>) <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/rtables/man/split_cols_by_multivar.html">split_cols_by_multivar</a></span>(
        <span class="kw">vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"AVAL"</span>, <span class="st">"CHG"</span>),
        <span class="kw">varlabels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Value"</span>, <span class="st">"Change"</span>)
      ),

    <span class="kw">env</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
      <span class="kw">arm</span> <span class="kw">=</span> <span class="no">arm</span>,
      <span class="kw">visit</span> <span class="kw">=</span> <span class="no">visit</span>
    )
  )

  <span class="no">lyt</span>$<span class="no">analyze</span> <span class="kw">&lt;-</span> <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="no">.stats</span>)) {
    <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(
      <span class="fu"><a href="https://rdrr.io/pkg/tern/man/summarize_colvars.html">summarize_colvars</a></span>()
    )
  } <span class="kw">else</span> {
    <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(
      <span class="fu"><a href="https://rdrr.io/pkg/tern/man/summarize_colvars.html">summarize_colvars</a></span>(<span class="kw">.stats</span> <span class="kw">=</span> <span class="no">.stats</span>),
      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">.stats</span> <span class="kw">=</span> <span class="no">.stats</span>)
    )
  }
  <span class="no">lyt</span>$<span class="no">build</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(
    <span class="fu"><a href="https://rdrr.io/pkg/rtables/man/build_table.html">build_table</a></span>(<span class="kw">df</span> <span class="kw">=</span> <span class="no">df</span>),
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">df</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(<span class="no">df</span>))
  )
  <span class="no">y</span>$<span class="no">rtables</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/pipe_expr.html">pipe_expr</a></span>(<span class="no">lyt</span>)

  <span class="co"># Finally returns y as a list with two expressions.</span>
  <span class="no">y</span>
}</pre></body></html></div>
<p>It is now possible to modify the studied parameter (<code>PARAMCD</code>) in addition to the study arm and visit variables names.</p>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="no">adlb</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/random.cdisc.data/man/radlb.html">radlb</a></span>(<span class="kw">cached</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu">rtables_expr</span>(
  <span class="kw">df</span> <span class="kw">=</span> <span class="no">adlb</span>, <span class="kw">paramcd</span> <span class="kw">=</span> <span class="st">"CRP"</span>, <span class="kw">arm</span> <span class="kw">=</span> <span class="st">"ARM"</span>, <span class="kw">visit</span> <span class="kw">=</span> <span class="st">"AVISIT"</span>,
  <span class="kw">.stats</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"n"</span>, <span class="st">"mean_sd"</span>)
)</pre></body></html></div>
<p>The two expressions are consistent:</p>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="fu"><a href="../reference/styled_expr.html">styled_expr</a></span>(<span class="no">result</span>$<span class="no">data</span>)
<span class="co">## adlb &lt;- adlb %&gt;% filter(</span>
<span class="co">##   PARAMCD == "CRP" &amp; ARMCD %in% c(</span>
<span class="co">##     "ARM A",</span>
<span class="co">##     "ARM B"</span>
<span class="co">##   ) &amp;</span>
<span class="co">##       AVISIT == "WEEK 1 DAY 8"</span>
<span class="co">## )</span>
<span class="fu"><a href="../reference/styled_expr.html">styled_expr</a></span>(<span class="no">result</span>$<span class="no">rtables</span>)
<span class="co">## basic_table() %&gt;%</span>
<span class="co">##   split_cols_by("ARM", split_fun = drop_split_levels) %&gt;%</span>
<span class="co">##   split_rows_by("AVISIT", split_fun = drop_split_levels) %&gt;%</span>
<span class="co">##   split_cols_by_multivar(</span>
<span class="co">##     vars = c("AVAL", "CHG"),</span>
<span class="co">##     varlabels = c(</span>
<span class="co">##       "Value",</span>
<span class="co">##       "Change"</span>
<span class="co">##     )</span>
<span class="co">##   ) %&gt;%</span>
<span class="co">##   summarize_colvars(.stats = c("n", "mean_sd")) %&gt;%</span>
<span class="co">##   build_table(df = adlb)</span></pre></body></html></div>
<p>The two expressions can be executed and return the <code>rtables</code>:</p>
<div class="sourceCode" id="cb26"><html><body><pre class="r"><span class="no">result_exec</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html">mapply</a></span>(<span class="no">eval</span>, <span class="no">result</span>)
<span class="no">result_exec</span>$<span class="no">rtables</span>
<span class="co">##                       A: Drug X                B: Placebo       </span>
<span class="co">##                  Value        Change       Value        Change  </span>
<span class="co">## ----------------------------------------------------------------</span>
<span class="co">## WEEK 1 DAY 8                                                    </span>
<span class="co">##   n               134          134          134          134    </span>
<span class="co">##   Mean (SD)    51.9 (8.1)   2.9 (12.5)   50.3 (8.8)   0.2 (11.6)</span></pre></body></html></div>
</div>
<div id="in-a-nutshell-1" class="section level2">
<h2 class="hasAnchor">
<a href="#in-a-nutshell-1" class="anchor"></a>In a nutshell</h2>
<p>At this point, it is then possible to:</p>
<ul>
<li>generate <code>rtables</code> pipelines.</li>
<li>chain expressions in a pipeline (e.g. <code>pipe_expr</code>)</li>
<li>decompose a <code>rtables</code> pipeline to add <strong>conditional</strong> layers (e.g. <code>.stats</code>).</li>
<li>group expressions into a single list and control both <strong>pre-processing</strong> and <strong><code>rtables</code> pipeline</strong>.</li>
</ul>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by NEST, Adrian Waddell, Heng Wang, Yuyao Song, Chendi Liao, Mark Rothe, Xiao Yu Mo, Roche.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
