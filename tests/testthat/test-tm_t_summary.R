test_that("template_summary generates correct expressions", {
  test.nest::skip_if_too_deep(0)

  result <- template_summary(
    dataname = "adrs",
    parentname = "adsl",
    arm_var = "ARM",
    sum_vars = c("RACE", "COUNTRY", "AGE"),
    show_labels = "visible",
    add_total = FALSE,
    var_labels = character(),
    na.rm = FALSE,
    denominator = "N",
    drop_arm_levels = TRUE
  )
  expected <- list(
    data = quote({
      anl <- adrs %>%
        df_explicit_na(
          omit_columns = setdiff(names(adrs), c(c("RACE", "COUNTRY", "AGE"))),
          na_level = "<Missing>"
        )
      anl <- anl %>% mutate(ARM = droplevels(ARM))
      arm_levels <- levels(anl[["ARM"]])
      adsl <- adsl %>% filter(ARM %in% arm_levels)
      adsl <- adsl %>% mutate(ARM = droplevels(ARM))
      adsl <- df_explicit_na(adsl, na_level = "")
    }),
    layout = quote(
      lyt <- basic_table() %>%
        split_cols_by("ARM") %>%
        add_colcounts() %>%
        summarize_vars(
          vars = c("RACE", "COUNTRY", "AGE"),
          show_labels = "visible",
          na.rm = FALSE,
          na_level = "<Missing>",
          denom = "N_col",
          .stats = c("n", "mean_sd", "mean_ci", "median", "median_ci", "quantiles", "range", "count_fraction")
        )
    ),
    table = quote({
      result <- build_table(lyt = lyt, df = anl, alt_counts_df = adsl)
      result
    })
  )
  expect_equal(result, expected)
})

test_that("template_summary can generate customized table", {
  test.nest::skip_if_too_deep(0)

  result <- template_summary(
    dataname = "adrs",
    parentname = "adsl",
    arm_var = "ARMCD",
    sum_vars = "RACE",
    show_labels = "visible",
    add_total = TRUE,
    var_labels = c(RACE = "Race"),
    na.rm = TRUE,
    denominator = "omit",
    drop_arm_levels = FALSE
  )
  expected <- list(
    data = quote({
      anl <- adrs %>%
        df_explicit_na(
          omit_columns = setdiff(names(adrs), c("RACE")),
          na_level = "<Missing>"
        )
      adsl <- adsl %>% mutate(ARMCD = droplevels(ARMCD))
      arm_levels <- levels(adsl[["ARMCD"]])
      anl <- anl %>% mutate(ARMCD = factor(ARMCD, levels = arm_levels))
      adsl <- df_explicit_na(adsl, na_level = "")
    }),
    layout = quote(
      lyt <- basic_table() %>%
        split_cols_by("ARMCD") %>%
        add_overall_col("All Patients") %>%
        add_colcounts() %>%
        summarize_vars(
          vars = "RACE",
          var_labels = c(RACE = "Race"),
          show_labels = "visible",
          na.rm = TRUE,
          na_level = "<Missing>",
          denom = "N_col",
          .stats = c("n", "mean_sd", "mean_ci", "median", "median_ci", "quantiles", "range", "count")
        )
    ),
    table = quote({
      result <- build_table(lyt = lyt, df = anl, alt_counts_df = adsl)
      result
    })
  )
  expect_equal(result, expected)
})

test_that("template_summary generates correct expressions for multiple grouping variables", {
  test.nest::skip_if_too_deep(0)

  result <- template_summary(
    dataname = "adrs",
    parentname = "adsl",
    arm_var = c("ARM", "STRATA1"),
    sum_vars = c("RACE", "COUNTRY", "AGE"),
    show_labels = "visible",
    add_total = FALSE,
    var_labels = character(),
    na.rm = FALSE,
    denominator = "N",
    drop_arm_levels = TRUE
  )
  expected <- list(
    data = quote({
      anl <- adrs %>%
        df_explicit_na(
          omit_columns = setdiff(names(adrs), c(c("RACE", "COUNTRY", "AGE"))),
          na_level = "<Missing>"
        )
      anl <- anl %>% mutate(ARM = droplevels(ARM))
      arm_levels <- levels(anl[["ARM"]])
      adsl <- adsl %>% filter(ARM %in% arm_levels)
      adsl <- adsl %>% mutate(ARM = droplevels(ARM))
      anl <- anl %>% mutate(STRATA1 = droplevels(STRATA1))
      arm_levels <- levels(anl[["STRATA1"]])
      adsl <- adsl %>% filter(STRATA1 %in% arm_levels)
      adsl <- adsl %>% mutate(STRATA1 = droplevels(STRATA1))
      adsl <- df_explicit_na(adsl, na_level = "")
    }),
    layout = quote(
      lyt <- basic_table() %>%
        split_cols_by("ARM") %>%
        split_cols_by("STRATA1", split_fun = drop_split_levels) %>%
        add_colcounts() %>%
        summarize_vars(
          vars = c("RACE", "COUNTRY", "AGE"),
          show_labels = "visible",
          na.rm = FALSE,
          na_level = "<Missing>",
          denom = "N_col",
          .stats = c("n", "mean_sd", "mean_ci", "median", "median_ci", "quantiles", "range", "count_fraction")
        )
    ),
    table = quote({
      result <- build_table(lyt = lyt, df = anl, alt_counts_df = adsl)
      result
    })
  )
  expect_equal(result, expected)
})

test_that("template_summary generates correct expressions for multiple grouping variables and all patientts", {
  test.nest::skip_if_too_deep(0)

  result <- template_summary(
    dataname = "adrs",
    parentname = "adsl",
    arm_var = c("ARM", "STRATA1"),
    sum_vars = c("RACE", "COUNTRY", "AGE"),
    show_labels = "visible",
    add_total = TRUE,
    var_labels = character(),
    na.rm = FALSE,
    denominator = "N",
    drop_arm_levels = TRUE
  )
  expected <- list(
    data = quote({
      anl <- adrs %>%
        df_explicit_na(
          omit_columns = setdiff(names(adrs), c(c("RACE", "COUNTRY", "AGE"))),
          na_level = "<Missing>"
        )
      anl <- anl %>% mutate(ARM = droplevels(ARM))
      arm_levels <- levels(anl[["ARM"]])
      adsl <- adsl %>% filter(ARM %in% arm_levels)
      adsl <- adsl %>% mutate(ARM = droplevels(ARM))
      anl <- anl %>% mutate(STRATA1 = droplevels(STRATA1))
      arm_levels <- levels(anl[["STRATA1"]])
      adsl <- adsl %>% filter(STRATA1 %in% arm_levels)
      adsl <- adsl %>% mutate(STRATA1 = droplevels(STRATA1))
      adsl <- df_explicit_na(adsl, na_level = "")
    }),
    layout = quote(
      lyt <- basic_table() %>%
        split_cols_by("ARM") %>%
        split_cols_by("STRATA1", split_fun = drop_split_levels) %>%
        add_overall_col("All Patients") %>%
        add_colcounts() %>%
        summarize_vars(
          vars = c("RACE", "COUNTRY", "AGE"),
          show_labels = "visible",
          na.rm = FALSE,
          na_level = "<Missing>",
          denom = "N_col",
          .stats = c("n", "mean_sd", "mean_ci", "median", "median_ci", "quantiles", "range", "count_fraction")
        )
    ),
    table = quote({
      result <- build_table(lyt = lyt, df = anl, alt_counts_df = adsl)
      result
    })
  )
  expect_equal(result, expected)
})

test_that("template_summary generates correct expressions for customized numeric statistics", {
  test.nest::skip_if_too_deep(0)

  result <- template_summary(
    dataname = "adrs",
    parentname = "adsl",
    arm_var = c("ARM", "STRATA1"),
    sum_vars = c("RACE", "COUNTRY", "AGE"),
    show_labels = "visible",
    add_total = FALSE,
    var_labels = character(),
    na.rm = FALSE,
    numeric_stats = c("n"),
    denominator = "N",
    drop_arm_levels = TRUE
  )
  expected <- list(
    data = quote({
      anl <- adrs %>%
        df_explicit_na(
          omit_columns = setdiff(names(adrs), c(c("RACE", "COUNTRY", "AGE"))),
          na_level = "<Missing>"
        )
      anl <- anl %>% mutate(ARM = droplevels(ARM))
      arm_levels <- levels(anl[["ARM"]])
      adsl <- adsl %>% filter(ARM %in% arm_levels)
      adsl <- adsl %>% mutate(ARM = droplevels(ARM))
      anl <- anl %>% mutate(STRATA1 = droplevels(STRATA1))
      arm_levels <- levels(anl[["STRATA1"]])
      adsl <- adsl %>% filter(STRATA1 %in% arm_levels)
      adsl <- adsl %>% mutate(STRATA1 = droplevels(STRATA1))
      adsl <- df_explicit_na(adsl, na_level = "")
    }),
    layout = quote(
      lyt <- basic_table() %>%
        split_cols_by("ARM") %>%
        split_cols_by("STRATA1", split_fun = drop_split_levels) %>%
        add_colcounts() %>%
        summarize_vars(
          vars = c("RACE", "COUNTRY", "AGE"),
          show_labels = "visible",
          na.rm = FALSE,
          na_level = "<Missing>",
          denom = "N_col",
          .stats = c("n", "count_fraction")
        )
    ),
    table = quote({
      result <- build_table(lyt = lyt, df = anl, alt_counts_df = adsl)
      result
    })
  )
  expect_equal(result, expected)
})
